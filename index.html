<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }
        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            border: none;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        .kpi-buy {
            border-left: 5px solid #28a745;
        }
        .kpi-sell {
            border-left: 5px solid #dc3545;
        }
        .kpi-expenditure {
            border-left: 5px solid #ffc107;
        }
        .kpi-title {
            font-size: 1rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        .last-updated {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            margin-top: 20px;
        }
        .currency {
            font-size: 1.5rem;
            vertical-align: top;
        }
        .kpi-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1 class="display-4">ðŸ“Š Stock Trading Dashboard</h1>
            <p class="lead">Real-time tracking of your daily trading activities</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Total Buy Card -->
            <div class="col-md-4">
                <div class="kpi-card kpi-buy">
                    <div class="kpi-icon text-success">ðŸ’°</div>
                    <div class="kpi-title">Total Buy</div>
                    <div class="kpi-value" id="totalBuy">
                        <div class="spinner-border spinner-border-sm text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="text-muted">Sum of all buy transactions</div>
                </div>
            </div>

            <!-- Total Sell Card -->
            <div class="col-md-4">
                <div class="kpi-card kpi-sell">
                    <div class="kpi-icon text-danger">ðŸ’¸</div>
                    <div class="kpi-title">Total Sell</div>
                    <div class="kpi-value" id="totalSell">
                        <div class="spinner-border spinner-border-sm text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="text-muted">Sum of all sell transactions</div>
                </div>
            </div>

            <!-- Daily Expenditure Card -->
            <div class="col-md-4">
                <div class="kpi-card kpi-expenditure">
                    <div class="kpi-icon text-warning">ðŸ“ˆ</div>
                    <div class="kpi-title">Daily Expenditure</div>
                    <div class="kpi-value" id="dailyExpenditure">
                        <div class="spinner-border spinner-border-sm text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="text-muted">Net expenditure (Buy - Sell)</div>
                </div>
            </div>
        </div>

        <!-- Summary Chart -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="kpi-card">
                    <h5 class="mb-4">ðŸ“ˆ Trading Summary</h5>
                    <canvas id="summaryChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">
            Last updated: <span id="updateTime">Never</span>
        </div>

        <div class="row mt-4">
            <div class="col-12 text-center">
                <button class="btn btn-primary" onclick="fetchData()">
                    ðŸ”„ Refresh Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Replace these with your actual sheet IDs
        const SHEET_ID = '12yHqIhFQZyEwYJlmBfscDmaXZpp2lXQK';
        const BUY_SHEET_GID = '752590382';
        const SELL_SHEET_GID = '1412337879';
        
        // Google Sheets CSV endpoints
        const BUY_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${BUY_SHEET_GID}`;
        const SELL_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SELL_SHEET_GID}`;

        // Chart instance
        let summaryChart = null;

        // Function to parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            return data;
        }

        // Function to fetch and calculate total from a sheet
        async function fetchSheetTotal(url, columnName) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const data = parseCSV(csvText);
                
                // Find the column index
                const headers = Object.keys(data[0] || {});
                const columnIndex = headers.findIndex(h => 
                    h.toLowerCase().includes(columnName.toLowerCase())
                );
                
                if (columnIndex === -1) {
                    console.warn(`Column "${columnName}" not found. Available columns:`, headers);
                    return 0;
                }
                
                // Sum all values in the column
                let total = 0;
                data.forEach(row => {
                    const value = parseFloat(row[headers[columnIndex]]);
                    if (!isNaN(value)) {
                        total += value;
                    }
                });
                
                return total;
            } catch (error) {
                console.error(`Error fetching data from ${url}:`, error);
                return 0;
            }
        }

        // Format number with commas and 2 decimal places
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        // Update the chart
        function updateChart(buyTotal, sellTotal, expenditure) {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            if (summaryChart) {
                summaryChart.destroy();
            }
            
            summaryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Buy', 'Sell', 'Net Expenditure'],
                    datasets: [{
                        label: 'Amount (â‚¹)',
                        data: [buyTotal, sellTotal, expenditure],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)'
                        ],
                        borderColor: [
                            'rgb(40, 167, 69)',
                            'rgb(220, 53, 69)',
                            'rgb(255, 193, 7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `â‚¹${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚¹' + formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Main function to fetch all data and update dashboard
        async function fetchData() {
            try {
                // Show loading states
                document.getElementById('totalBuy').innerHTML = 
                    '<div class="spinner-border spinner-border-sm text-success" role="status"><span class="visually-hidden">Loading...</span></div>';
                document.getElementById('totalSell').innerHTML = 
                    '<div class="spinner-border spinner-border-sm text-danger" role="status"><span class="visually-hidden">Loading...</span></div>';
                document.getElementById('dailyExpenditure').innerHTML = 
                    '<div class="spinner-border spinner-border-sm text-warning" role="status"><span class="visually-hidden">Loading...</span></div>';

                // Fetch data from both sheets
                const [buyTotal, sellTotal] = await Promise.all([
                    fetchSheetTotal(BUY_SHEET_URL, 'Total_Cost_Buy'),
                    fetchSheetTotal(SELL_SHEET_URL, 'Total_Cost_Sell')
                ]);

                // Calculate daily expenditure
                const dailyExpenditure = buyTotal - sellTotal;

                // Update KPI cards
                document.getElementById('totalBuy').innerHTML = 
                    `<span class="currency">â‚¹</span>${formatNumber(buyTotal)}`;
                document.getElementById('totalSell').innerHTML = 
                    `<span class="currency">â‚¹</span>${formatNumber(sellTotal)}`;
                document.getElementById('dailyExpenditure').innerHTML = 
                    `<span class="currency">â‚¹</span>${formatNumber(dailyExpenditure)}`;

                // Color code for expenditure
                const expenditureElement = document.getElementById('dailyExpenditure');
                if (dailyExpenditure > 0) {
                    expenditureElement.style.color = '#dc3545'; // Red for positive expenditure
                } else if (dailyExpenditure < 0) {
                    expenditureElement.style.color = '#28a745'; // Green for negative expenditure (profit)
                }

                // Update chart
                updateChart(buyTotal, sellTotal, dailyExpenditure);

                // Update last updated time
                const now = new Date();
                document.getElementById('updateTime').textContent = 
                    now.toLocaleTimeString() + ' ' + now.toLocaleDateString();

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                
                // Show error in KPI cards
                document.getElementById('totalBuy').innerHTML = 
                    '<span class="text-danger">Error</span>';
                document.getElementById('totalSell').innerHTML = 
                    '<span class="text-danger">Error</span>';
                document.getElementById('dailyExpenditure').innerHTML = 
                    '<span class="text-danger">Error</span>';
                
                alert('Error loading data. Please check console for details.');
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', fetchData);

        // Auto-refresh every 5 minutes (optional)
        // setInterval(fetchData, 5 * 60 * 1000);
    </script>
</body>
</html>
