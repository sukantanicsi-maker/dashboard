<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Stock Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .kpi-card {
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-card.buy {
            border-top: 4px solid var(--success-color);
            background: linear-gradient(135deg, #ffffff, #d5f4e6);
        }
        
        .kpi-card.sell {
            border-top: 4px solid var(--danger-color);
            background: linear-gradient(135deg, #ffffff, #fadbd8);
        }
        
        .kpi-card.expense {
            border-top: 4px solid var(--warning-color);
            background: linear-gradient(135deg, #ffffff, #fef9e7);
        }
        
        .kpi-card.profit {
            border-top: 4px solid var(--secondary-color);
            background: linear-gradient(135deg, #ffffff, #e8f4fc);
        }
        
        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .kpi-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .last-updated {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        
        .error-card {
            background-color: #fadbd8;
            border-left: 4px solid var(--danger-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Daily Stock Dashboard</h1>
                    <p class="lead mb-0">Real-time tracking of your stock transactions and expenditures</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="last-updated" id="lastUpdated">
                        Last updated: Loading...
                    </div>
                    <button class="refresh-btn mt-2" onclick="loadData()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p class="mt-3">Loading dashboard data...</p>
        </div>

        <!-- Error Display -->
        <div id="errorContainer" style="display: none;"></div>

        <!-- KPI Cards -->
        <div id="dashboardContent" style="display: none;">
            <div class="row">
                <div class="col-md-3 col-sm-6">
                    <div class="kpi-card buy">
                        <div class="kpi-icon text-success">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="kpi-value text-success" id="totalBuy">₹0</div>
                        <div class="kpi-label">Total Buy</div>
                        <small class="text-muted">Sum of all stock purchases</small>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6">
                    <div class="kpi-card sell">
                        <div class="kpi-icon text-danger">
                            <i class="fas fa-cash-register"></i>
                        </div>
                        <div class="kpi-value text-danger" id="totalSell">₹0</div>
                        <div class="kpi-label">Total Sell</div>
                        <small class="text-muted">Sum of all stock sales</small>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6">
                    <div class="kpi-card expense">
                        <div class="kpi-icon text-warning">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="kpi-value text-warning" id="dailyExpenditure">₹0</div>
                        <div class="kpi-label">Daily Expenditure</div>
                        <small class="text-muted">Other operational expenses</small>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6">
                    <div class="kpi-card profit">
                        <div class="kpi-icon text-primary">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="kpi-value text-primary" id="netProfit">₹0</div>
                        <div class="kpi-label">Net Profit/Loss</div>
                        <small class="text-muted">Sell - Buy - Expenses</small>
                    </div>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Dashboard Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Transaction Summary</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-arrow-up text-success"></i> Total Investment: <span id="summaryBuy" class="fw-bold">₹0</span></li>
                                        <li><i class="fas fa-arrow-down text-danger"></i> Total Revenue: <span id="summarySell" class="fw-bold">₹0</span></li>
                                        <li><i class="fas fa-money-bill-wave text-warning"></i> Expenses: <span id="summaryExpense" class="fw-bold">₹0</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Performance Metrics</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-balance-scale text-primary"></i> Net Profit/Loss: <span id="summaryNet" class="fw-bold">₹0</span></li>
                                        <li><i class="fas fa-percentage text-info"></i> Profit Margin: <span id="profitMargin" class="fw-bold">0%</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Data Status</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-database"></i> Data Source: Google Sheets</li>
                                        <li><i class="fas fa-clock"></i> Last Updated: <span id="summaryUpdated">Just now</span></li>
                                        <li><i class="fas fa-check-circle text-success"></i> Status: <span id="dataStatus">Live</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets URLs
        const SHEETS_CONFIG = {
            buy: {
                url: 'https://docs.google.com/spreadsheets/d/12yHqIhFQZyEwYJlmBfscDmaXZpp2lXQK/gviz/tq?tqx=out:csv&gid=752590382',
                column: 'Total_Cost_Buy'
            },
            sell: {
                url: 'https://docs.google.com/spreadsheets/d/12yHqIhFQZyEwYJlmBfscDmaXZpp2lXQK/gviz/tq?tqx=out:csv&gid=1412337879',
                column: 'Total_Cost_Sell'
            },
            expense: {
                url: 'https://docs.google.com/spreadsheets/d/12yHqIhFQZyEwYJlmBfscDmaXZpp2lXQK/gviz/tq?tqx=out:csv&gid=1557222749',
                column: 'Total_Cost_Other'
            }
        };

        // Format currency in Indian Rupees
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const obj = {};
                const currentline = lines[i].split(',');
                
                headers.forEach((header, index) => {
                    let value = currentline[index] || '';
                    value = value.trim().replace(/"/g, '');
                    
                    // Try to convert to number if it's a numeric value
                    if (!isNaN(value) && value !== '') {
                        value = parseFloat(value);
                    }
                    
                    obj[header] = value;
                });
                
                result.push(obj);
            }
            
            return result;
        }

        // Calculate sum of a specific column
        function calculateSum(data, columnName) {
            return data.reduce((sum, row) => {
                const value = parseFloat(row[columnName]) || 0;
                return sum + value;
            }, 0);
        }

        // Fetch data from Google Sheets
        async function fetchSheetData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                return csvText;
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        // Display error message
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-card">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error Loading Data</h5>
                    <p>${message}</p>
                    <p>Please check:</p>
                    <ul>
                        <li>Your internet connection</li>
                        <li>Google Sheets sharing settings (make sure links are public)</li>
                        <li>Try refreshing the page</li>
                    </ul>
                </div>
            `;
            errorContainer.style.display = 'block';
        }

        // Update the dashboard with new data
        function updateDashboard(buyTotal, sellTotal, expenseTotal) {
            // Calculate net profit/loss
            const netProfit = sellTotal - buyTotal - expenseTotal;
            
            // Calculate profit margin (avoid division by zero)
            const profitMargin = sellTotal > 0 ? ((netProfit / sellTotal) * 100).toFixed(1) : 0;
            
            // Update KPI cards
            document.getElementById('totalBuy').textContent = formatCurrency(buyTotal);
            document.getElementById('totalSell').textContent = formatCurrency(sellTotal);
            document.getElementById('dailyExpenditure').textContent = formatCurrency(expenseTotal);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            
            // Update summary section
            document.getElementById('summaryBuy').textContent = formatCurrency(buyTotal);
            document.getElementById('summarySell').textContent = formatCurrency(sellTotal);
            document.getElementById('summaryExpense').textContent = formatCurrency(expenseTotal);
            document.getElementById('summaryNet').textContent = formatCurrency(netProfit);
            document.getElementById('profitMargin').textContent = `${profitMargin}%`;
            
            // Color code net profit
            const netElement = document.getElementById('netProfit');
            const summaryNet = document.getElementById('summaryNet');
            
            if (netProfit > 0) {
                netElement.className = 'kpi-value text-success';
                summaryNet.className = 'fw-bold text-success';
            } else if (netProfit < 0) {
                netElement.className = 'kpi-value text-danger';
                summaryNet.className = 'fw-bold text-danger';
            } else {
                netElement.className = 'kpi-value text-secondary';
                summaryNet.className = 'fw-bold text-secondary';
            }
            
            // Update last updated time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const dateString = now.toLocaleDateString();
            
            document.getElementById('lastUpdated').innerHTML = 
                `<i class="fas fa-clock"></i> Last updated: ${dateString} ${timeString}`;
            document.getElementById('summaryUpdated').textContent = `${dateString} ${timeString}`;
        }

        // Main function to load all data
        async function loadData() {
            const loadingElement = document.getElementById('loading');
            const dashboardElement = document.getElementById('dashboardContent');
            const errorContainer = document.getElementById('errorContainer');
            
            // Show loading, hide dashboard and clear errors
            loadingElement.style.display = 'flex';
            dashboardElement.style.display = 'none';
            errorContainer.style.display = 'none';
            
            try {
                // Fetch all data in parallel
                const [buyData, sellData, expenseData] = await Promise.all([
                    fetchSheetData(SHEETS_CONFIG.buy.url),
                    fetchSheetData(SHEETS_CONFIG.sell.url),
                    fetchSheetData(SHEETS_CONFIG.expense.url)
                ]);
                
                // Parse CSV data
                const buyParsed = parseCSV(buyData);
                const sellParsed = parseCSV(sellData);
                const expenseParsed = parseCSV(expenseData);
                
                // Calculate totals
                const buyTotal = calculateSum(buyParsed, SHEETS_CONFIG.buy.column);
                const sellTotal = calculateSum(sellParsed, SHEETS_CONFIG.sell.column);
                const expenseTotal = calculateSum(expenseParsed, SHEETS_CONFIG.expense.column);
                
                console.log('Data loaded successfully:', {
                    buyTotal,
                    sellTotal,
                    expenseTotal,
                    buyRecords: buyParsed.length,
                    sellRecords: sellParsed.length,
                    expenseRecords: expenseParsed.length
                });
                
                // Update dashboard
                updateDashboard(buyTotal, sellTotal, expenseTotal);
                
                // Hide loading, show dashboard
                loadingElement.style.display = 'none';
                dashboardElement.style.display = 'block';
                document.getElementById('dataStatus').textContent = 'Live';
                document.getElementById('dataStatus').className = 'text-success';
                
            } catch (error) {
                console.error('Error in loadData:', error);
                
                // Hide loading
                loadingElement.style.display = 'none';
                
                // Show error
                showError(`Failed to load data: ${error.message}`);
                
                // Still show dashboard with zeros or previous data
                dashboardElement.style.display = 'block';
                document.getElementById('dataStatus').textContent = 'Offline';
                document.getElementById('dataStatus').className = 'text-danger';
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Auto-refresh every 5 minutes
            setInterval(loadData, 5 * 60 * 1000);
        });

        // Add keyboard shortcut for refresh (Ctrl+R or Cmd+R)
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                loadData();
            }
        });
    </script>
</body>
</html>
